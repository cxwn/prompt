# CILMS开发提示词模块化分解

## 1. 项目架构设计模块

### 1.1 系统架构设计提示词

**角色定义**: 你是一名资深的系统架构师，专精于Go语言生态和Linux系统架构设计。

**任务目标**: 为CILMS (Container Initialization and Log Management System) 设计完整的系统架构。

**设计要求**:
- 设计模块化的系统架构，确保高内聚低耦合
- 明确各模块间的依赖关系和数据流向
- 考虑容器环境和非容器环境的兼容性
- 设计支持PID 1模式和守护进程模式的架构
- 确保并发安全和性能优化

**交付物**:
1. 系统整体架构图（包含模块划分和依赖关系）
2. 核心流程图（启动、监控、重启、停止流程）
3. 时序图（进程生命周期管理时序）
4. 数据流图（配置、日志、状态数据流向）
5. 部署架构图（容器和非容器环境部署方案）

**技术约束**:
- 使用Go 1.24.2语言特性
- 支持Linux内核3.10+
- 内存占用不超过50MB
- 启动时间不超过5秒

### 1.2 接口设计提示词

**角色定义**: 你是一名资深的API设计专家，专精于CLI和RESTful API设计。

**任务目标**: 设计CILMS的命令行接口和HTTP API接口规范。

**设计要求**:
- CLI接口遵循UNIX哲学，简洁易用
- HTTP API遵循RESTful设计原则
- 统一的错误处理和响应格式
- 支持JSON格式的数据交换
- 提供完整的接口文档和示例

**交付物**:
1. CLI命令行接口规范文档
2. HTTP API接口规范文档
3. 请求/响应格式定义
4. 错误码和错误信息规范
5. 接口使用示例和测试用例

**技术约束**:
- 使用urfave/cli/v2框架
- 使用gin-gonic/gin框架
- HTTP响应时间不超过500ms
- 支持并发请求处理

## 2. 配置管理模块

### 2.1 配置系统设计提示词

**角色定义**: 你是一名资深的Go语言开发工程师，专精于配置管理和YAML解析。

**任务目标**: 实现CILMS的配置管理系统，包括配置加载、校验、默认值处理。

**功能要求**:
- 支持YAML格式配置文件
- 支持命令行参数覆盖配置文件
- 支持环境变量替换
- 提供配置校验机制
- 支持配置热重载（可选）
- 全局单例模式，线程安全

**实现细节**:
- 使用gopkg.in/yaml.v3进行YAML解析
- 实现配置结构体定义和标签
- 实现配置校验规则
- 实现默认值设置机制
- 实现环境变量替换功能

**交付物**:
```go
// internal/config/config.go
// internal/config/validation.go
// configs/cilms.yaml
```

### 2.2 配置校验提示词

**角色定义**: 你是一名专精于数据校验的Go语言开发工程师。

**任务目标**: 实现配置文件的完整性校验和合法性检查。

**校验要求**:
- 必填字段检查
- 数值范围校验
- 文件路径存在性检查
- 进程依赖循环检查
- 端口可用性检查
- 权限检查

**实现细节**:
- 设计校验接口和规则引擎
- 实现各类校验函数
- 提供详细的错误信息
- 支持校验结果缓存

## 3. 日志管理模块

### 3.1 日志系统设计提示词

**角色定义**: 你是一名专精于日志系统设计的Go语言开发工程师。

**任务目标**: 实现CILMS的统一日志管理系统。

**功能要求**:
- 支持多级别日志输出（DEBUG/INFO/WARN/ERROR/FATAL）
- 支持控制台和文件双重输出
- 支持text和json两种格式
- 支持颜色输出
- 全局单例，线程安全
- 高性能异步日志

**技术规范**:
- 使用logrus日志库
- 时间格式: 2023-08-01 20:00:00.000
- 级别宽度: 固定5字符左对齐
- 模板: {时间} {级别} {PID} {文件}:{行号} {消息}

**交付物**:
```go
// internal/logger/logger.go
```

### 3.2 日志轮转系统提示词

**角色定义**: 你是一名专精于文件系统操作的Go语言开发工程师。

**任务目标**: 实现日志文件轮转和归档管理。

**功能要求**:
- 基于文件大小的轮转
- 基于时间的轮转
- 历史文件压缩
- 自动清理过期文件
- 支持并发写入安全

**技术规范**:
- 使用lumberjack.v2库
- 支持自定义轮转策略
- 支持多进程日志轮转
- 实现轮转状态监控

**交付物**:
```go
// internal/logger/rotator.go
```

## 4. 进程管理核心模块

### 4.1 进程管理器设计提示词

**角色定义**: 你是一名资深的Linux系统编程专家，专精于进程管理和信号处理。

**任务目标**: 实现CILMS的核心进程管理器。

**功能要求**:
- 进程生命周期完整管理
- 支持进程启动、停止、重启
- 实现进程状态跟踪
- 支持信号处理和优雅停止
- 支持进程组管理
- 线程安全的并发控制

**实现细节**:
- 设计进程管理器接口
- 实现进程启动策略
- 实现优雅停止机制
- 实现进程状态同步
- 处理僵尸进程和孤儿进程

**交付物**:
```go
// internal/process/manager.go
// internal/process/process.go
```

### 4.2 进程监控系统提示词

**角色定义**: 你是一名专精于系统监控的Go语言开发工程师。

**任务目标**: 实现进程运行状态监控和异常检测。

**监控指标**:
- 进程状态（运行/停止/重启/失败）
- 运行时间统计
- 重启统计
- 退出信息收集
- 资源使用情况

**检测机制**:
- 周期性健康检查（30秒间隔）
- 僵尸进程检测和回收
- 孤儿进程检测和处理
- 异常进程自动恢复

**交付物**:
```go
// internal/process/monitor.go
```

### 4.3 依赖管理系统提示词

**角色定义**: 你是一名专精于依赖解析的算法工程师。

**任务目标**: 实现进程间依赖关系管理和启动顺序控制。

**功能要求**:
- 依赖关系解析
- 循环依赖检测
- 启动顺序计算
- 依赖等待机制
- 级联重启处理

**算法要求**:
- 使用拓扑排序算法
- 实现依赖图构建
- 支持动态依赖变更
- 处理依赖失败场景

**交付物**:
```go
// internal/process/dependency.go
```

### 4.4 重启策略系统提示词

**角色定义**: 你是一名专精于容错系统设计的Go语言开发工程师。

**任务目标**: 实现进程重启策略和退避算法。

**重启策略**:
- always: 总是重启
- onFailure: 仅失败时重启
- never: 永不重启

**退避算法**:
- 指数退避策略
- 最大延迟限制（5分钟）
- 重启计数器管理
- 稳定运行重置机制

**实现细节**:
- 退避时间计算：min(10 * 2^(N-2), 300)秒
- 稳定运行阈值：600秒
- 最大重试次数限制
- 重启失败处理

## 5. 命令行接口模块

### 5.1 CLI命令实现提示词

**角色定义**: 你是一名专精于CLI应用开发的Go语言工程师。

**任务目标**: 实现CILMS的命令行接口功能。

**命令列表**:
- `cilms start`: 启动服务
- `cilms stop`: 停止服务
- `cilms restart`: 重启服务
- `cilms list`: 查看进程状态
- `cilms logs`: 查看日志
- `cilms zombies`: 僵尸进程管理
- `cilms orphans`: 孤儿进程管理

**技术要求**:
- 使用urfave/cli/v2框架
- 统一的参数解析和校验
- 友好的帮助信息
- 错误处理和用户提示

**交付物**:
```go
// cmd/start.go
// cmd/stop.go
// cmd/restart.go
// cmd/list.go
// cmd/logs.go
// cmd/zombies.go
// cmd/orphans.go
// internal/cli/commands.go
```

### 5.2 CLI核心逻辑提示词

**角色定义**: 你是一名专精于业务逻辑实现的Go语言开发工程师。

**任务目标**: 实现CLI命令的核心业务逻辑。

**实现要求**:
- 命令执行逻辑与HTTP API复用
- 统一的错误处理机制
- 支持前台和后台模式
- 支持实时日志输出
- 参数校验和转换

**核心函数**:
- StartCommand: 启动服务逻辑
- StopCommand: 停止服务逻辑
- RestartCommand: 重启服务逻辑
- ListCommand: 状态查询逻辑
- LogsCommand: 日志查看逻辑

## 6. HTTP API模块

### 6.1 HTTP服务器实现提示词

**角色定义**: 你是一名专精于Web API开发的Go语言工程师。

**任务目标**: 实现CILMS的HTTP API服务器。

**功能要求**:
- RESTful API设计
- 统一的响应格式
- 中间件支持（日志、跨域、认证）
- 优雅关闭
- 并发请求处理

**API端点**:
```
GET    /cilms/processes
GET    /cilms/processes/{pid}
POST   /cilms/processes/{pid}/restart
POST   /cilms/stop
POST   /cilms/restart
GET    /cilms/zombies
POST   /cilms/zombies/clean
GET    /cilms/orphans
POST   /cilms/orphans/clean
```

**技术要求**:
- 使用gin-gonic/gin框架
- JSON序列化和反序列化
- HTTP状态码规范
- 请求参数校验

**交付物**:
```go
// internal/api/server.go
```

## 7. 工具函数模块

### 7.1 系统工具函数提示词

**角色定义**: 你是一名专精于Linux系统编程的Go语言开发工程师。

**任务目标**: 实现CILMS所需的系统级工具函数。

**功能模块**:
- 信号处理工具
- PID文件管理
- 守护进程化
- 文件系统操作
- 系统信息获取

**实现要求**:
- 跨平台兼容性考虑
- 错误处理完善
- 性能优化
- 单元测试覆盖

**交付物**:
```go
// internal/utils/signal.go
// internal/utils/pid.go
// internal/utils/daemon.go
```

### 7.2 信号处理系统提示词

**角色定义**: 你是一名专精于Unix信号处理的系统编程专家。

**任务目标**: 实现CILMS的信号处理机制。

**信号处理**:
- SIGTERM: 优雅停止
- SIGINT: 中断处理
- SIGCHLD: 子进程状态变化
- SIGHUP: 配置重载
- SIGKILL: 强制终止

**实现细节**:
- 信号注册和处理
- 信号传播机制
- 优雅关闭流程
- 信号屏蔽和恢复

## 8. 构建和部署模块

### 8.1 构建系统提示词

**角色定义**: 你是一名专精于Go语言构建系统的DevOps工程师。

**任务目标**: 设计和实现CILMS的构建系统。

**构建要求**:
- 多平台编译支持（amd64、arm64）
- 版本管理和打标签
- 依赖管理和版本锁定
- 编译优化和压缩
- 自动化构建流程

**交付物**:
```makefile
# Makefile
```

```dockerfile
# Dockerfile
```

### 8.2 容器化部署提示词

**角色定义**: 你是一名专精于容器技术的DevOps工程师。

**任务目标**: 设计CILMS的容器化部署方案。

**容器要求**:
- 多阶段构建优化镜像大小
- 安全基础镜像选择
- 非root用户运行
- 健康检查配置
- 资源限制设置

**部署场景**:
- 作为容器PID 1运行
- 作为sidecar容器运行
- Kubernetes部署支持

## 9. 测试模块

### 9.1 单元测试提示词

**角色定义**: 你是一名专精于测试驱动开发的Go语言工程师。

**任务目标**: 为CILMS核心功能编写完整的单元测试。

**测试覆盖**:
- 配置管理模块测试
- 进程管理核心逻辑测试
- 日志系统测试
- 工具函数测试
- 错误场景测试

**测试要求**:
- 测试覆盖率达到80%以上
- Mock外部依赖
- 并发安全测试
- 性能基准测试
- 边界条件测试

**交付物**:
```go
// tests/unit/
```

### 9.2 集成测试提示词

**角色定义**: 你是一名专精于系统集成测试的测试工程师。

**任务目标**: 设计和实现CILMS的集成测试方案。

**测试场景**:
- 容器环境集成测试
- 非容器环境集成测试
- 多进程协作测试
- 故障恢复测试
- 性能压力测试

**测试工具**:
- Docker容器测试环境
- 自动化测试脚本
- 性能监控工具
- 日志分析工具

**交付物**:
```go
// tests/integration/
```

## 10. 文档和示例模块

### 10.1 用户文档提示词

**角色定义**: 你是一名专精于技术文档写作的技术作家。

**任务目标**: 编写CILMS的完整用户文档。

**文档内容**:
- 快速开始指南
- 安装和部署文档
- 配置文件详细说明
- CLI命令参考
- HTTP API文档
- 故障排除指南
- 最佳实践建议

**写作要求**:
- 清晰易懂的表达
- 完整的示例代码
- 图文并茂的说明
- 多场景使用案例

**交付物**:
```markdown
# README.md
# docs/installation.md
# docs/configuration.md
# docs/api-reference.md
# docs/troubleshooting.md
# docs/best-practices.md
```

### 10.2 示例和演示提示词

**角色定义**: 你是一名专精于示例开发的应用工程师。

**任务目标**: 创建CILMS的使用示例和演示场景。

**示例内容**:
- 基本使用示例
- 容器环境演示
- 多进程管理示例
- 日志管理演示
- API调用示例
- 故障模拟和恢复

**演示要求**:
- 可运行的示例代码
- Docker演示环境
- 自动化演示脚本
- 详细的操作说明

**交付物**:
```bash
# scripts/demo.sh
# examples/
# docker-compose.yml
```

## 总结

以上模块化分解将CILMS项目按照软件工程最佳实践进行了系统性划分，每个模块都有明确的职责边界和交付标准。开发团队可以按照模块并行开发，确保项目的高质量交付。每个模块的提示词都包含了具体的技术要求、实现细节和交付物清单，为开发人员提供了清晰的指导方向。

---

**文档生成时间**: 2025/6/19 13:15:59  
**版本**: v1.0  
**适用项目**: CILMS (Container Initialization and Log Management System)  
**技术栈**: Go 1.24.2, Linux, Docker, 容器技术